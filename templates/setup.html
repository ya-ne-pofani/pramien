<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</title>
    <link rel="stylesheet" href="/static/css/auth.css">
    <style>
        .picker-grid { display: flex; gap: 10px; justify-content: center; margin: 15px 0; flex-wrap: wrap; }
        .color-opt, .emoji-opt { 
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; border: 2px solid transparent;
        }
        .color-opt.selected, .emoji-opt.selected { border-color: white; transform: scale(1.1); }
        .emoji-opt { background: #333; font-size: 1.2rem; }
    </style>
</head>
<body>
    <div class="auth-card visible" style="width: 400px;">
        <h2>–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <form id="setup-form">
            <div class="form-group">
                <label>–ö–∞–∫ –≤–∞—Å –Ω–∞–∑—ã–≤–∞—Ç—å? (–ù–∏–∫–Ω–µ–π–º)</label>
                <input type="text" id="nickname" required maxlength="20" placeholder="–ò–º—è –≤ —á–∞—Ç–µ">
            </div>
            
            <div class="form-group">
                <label>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π @Handle</label>
                <input type="text" id="handle" required maxlength="20" placeholder="username">
            </div>

            <div class="form-group" style="text-align:center;">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</label>
                <div class="picker-grid" id="color-picker"></div>
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</label>
                <div class="picker-grid" id="emoji-picker"></div>
            </div>

            <button type="submit">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
            <div id="error-msg"></div>
        </form>
    </div>

    <script>
        const colors = ['#007aff', '#34c759', '#ff3b30', '#af52de', '#ff9500', '#5856d6'];
        const emojis = ['üòÄ','üòé','üëΩ','ü§ñ','üëª','üê±','ü¶ä','üêº'];
        let selectedColor = colors[0];
        let selectedEmoji = emojis[0];

        const cp = document.getElementById('color-picker');
        colors.forEach(c => {
            const d = document.createElement('div');
            d.className = 'color-opt' + (c === selectedColor ? ' selected' : '');
            d.style.backgroundColor = c;
            d.onclick = () => {
                selectedColor = c;
                document.querySelectorAll('.color-opt').forEach(el => el.classList.remove('selected'));
                d.classList.add('selected');
            };
            cp.appendChild(d);
        });

        const ep = document.getElementById('emoji-picker');
        emojis.forEach(e => {
            const d = document.createElement('div');
            d.className = 'emoji-opt' + (e === selectedEmoji ? ' selected' : '');
            d.textContent = e;
            d.onclick = () => {
                selectedEmoji = e;
                document.querySelectorAll('.emoji-opt').forEach(el => el.classList.remove('selected'));
                d.classList.add('selected');
            };
            ep.appendChild(d);
        });

        document.getElementById('setup-form').onsubmit = async (e) => {
            e.preventDefault();
            const nickname = document.getElementById('nickname').value;
            const handle = document.getElementById('handle').value;
            const errorMsg = document.getElementById('error-msg');

            try {
                const res = await fetch('/api/user/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nickname, handle, 
                        color: selectedColor, 
                        emoji: selectedEmoji 
                    })
                });
                const data = await res.json();

                if (data.success) {
                    window.location.href = '/';
                } else {
                    errorMsg.textContent = data.message;
                }
            } catch (err) {
                errorMsg.textContent = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
            }
        };
    </script>
</body>
</html>